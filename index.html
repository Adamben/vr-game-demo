<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Peer.js CRT Terminal Chat</title>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #000;
      color: #0f0;
      font-family: "Courier New", monospace;
      text-shadow: 0 0 5px #0f0, 0 0 10px #0f0;
      overflow: hidden;
    }
    #chat {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: 1.3em;
    }
    #inputBar {
      border-top: 1px solid #0f0;
    }
    #msgBox {
      width: 100%;
      background: #000;
      color: #0f0;
      border: none;
      outline: none;
      font-family: inherit;
      font-size: 16px;
      padding: 10px;
      text-shadow: 0 0 5px #0f0, 0 0 10px #0f0;
    }
    .system { color: #0f0; }
    .error { color: #f33; text-shadow: 0 0 5px #f33, 0 0 10px #f33; }
    .chat { color: #0f0; }
    /* CRT scanlines effect */
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: repeating-linear-gradient(
        to bottom,
        rgba(0, 255, 0, 0.1) 0px,
        rgba(0, 255, 0, 0.05) 2px,
        transparent 3px
      );
      pointer-events: none;
    }
    body::after {
      content: "";
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: radial-gradient(circle, rgba(0,255,0,0.1) 0%, transparent 80%);
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="chat"></div>
  <div id="inputBar">
    <input type="text" id="msgBox" placeholder="Type command or message..." autofocus>
  </div>

  <script>
    let peer;
    let connections = {};

    const chat = document.getElementById("chat");
    const msgBox = document.getElementById("msgBox");

    function log(msg, type="system") {
      const span = document.createElement("div");
      span.className = type;
      span.textContent = msg;
      chat.appendChild(span);
      chat.scrollTop = chat.scrollHeight;
    }

    msgBox.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        const text = msgBox.value.trim();
        msgBox.value = "";
        if (text) handleCommand(text);
      }
    });

    function handleCommand(input) {
      if (input.startsWith("/set ")) {
        const id = input.split(" ")[1];
        if (!id) return log("[Error] Usage: /set <yourid>", "error");
        if (peer) return log("[Error] Peer already created. Restart page to change ID.", "error");

        peer = new Peer(id);

        peer.on("open", () => log("[System] Peer ready with ID: " + id, "system"));
        peer.on("error", err => log("[Error] " + err.type, "error"));
        peer.on("connection", conn => {
          setupConnection(conn);
          conn.on("open", () => {
            const peerList = Object.keys(connections);
            conn.send({ type: "peer-list", peers: peerList });
          });
        });

      } else if (input.startsWith("/connect ")) {
        const id = input.split(" ")[1];
        if (!id) return log("[Error] Usage: /connect <peerid>", "error");
        if (!peer) return log("[Error] You must set your ID first with /set", "error");
        if (connections[id]) return log("[Error] Already connected to " + id, "error");

        const conn = peer.connect(id);
        setupConnection(conn);

      } else if (input === "/status") {
        if (!peer) return log("[Error] You must set your ID first with /set", "error");
        const peers = Object.keys(connections);
        log("[System] Connections: " + (peers.length ? peers.join(", ") : "none"), "system");

      } else if (input === "/help") {
        log("[System] Commands:\n" +
            "  /set <id>      - Set your peer ID\n" +
            "  /connect <id>  - Connect to another peer\n" +
            "  /status        - Show connected peers\n" +
            "  /help          - Show this help\n" +
            "  (anything else is sent as a message)", "system");

      } else {
        if (!peer) return log("[Error] You must set your ID first with /set", "error");
        sendMsg(input);
        log("Me: " + input, "chat");
      }
    }

    function setupConnection(conn) {
      conn.on("open", () => {
        connections[conn.peer] = conn;
        log("[System] Connected to " + conn.peer, "system");
      });

      conn.on("data", data => {
        if (typeof data === "string") {
          log(conn.peer + ": " + data, "chat");
        } else if (data.type === "peer-list") {
          data.peers.forEach(pid => {
            if (pid !== peer.id && !connections[pid]) {
              const c = peer.connect(pid);
              setupConnection(c);
            }
          });
        }
      });

      conn.on("close", () => {
        delete connections[conn.peer];
        log("[System] " + conn.peer + " disconnected.", "system");
      });
    }

    function sendMsg(msg) {
      for (let id in connections) {
        connections[id].send(msg);
      }
    }
  </script>
</body>
</html>
